{"pageProps":{"contentHtml":"<html><head></head><body><h1>How SlimFaas Works (Architecture)</h1>\n<p>Under the hood, SlimFaas is an <strong>HTTP proxy</strong> that intercepts requests for your functions, jobs, or events.\nIt handles scaling, routing, and state management.</p>\n<hr>\n<h2>1. Core Concepts</h2>\n<ol>\n<li>\n<p><strong>SlimFaas Pod</strong>\nRuns as a <strong>Deployment</strong> or <strong>StatefulSet</strong> (commonly 3 replicas in production). Each pod has internal workers:</p>\n<ul>\n<li><strong>SlimWorker</strong>: Handles async call processing.</li>\n<li><strong>SlimDataSynchronizationWorker</strong>: Manages the embedded database cluster (Raft-based).</li>\n<li><strong>HistorySynchronizationWorker</strong>: Syncs request history and logs.</li>\n<li><strong>ReplicasSynchronizationWorker</strong>: Keeps track of your function pods’ replicas and statuses in Kubernetes.</li>\n<li><strong>ReplicasScaleWorker</strong>: If the SlimFaas pod is leader, it scales up/down your function pods.</li>\n</ul>\n</li>\n<li>\n<p><strong>SlimData</strong>\nA built-in key-value store based on <a href=\"https://raft.github.io/\">Raft</a>, provided by .NET’s <a href=\"https://github.com/dotnet/dotNext\">dotNext</a>.\nThis database is crucial for consistent state among SlimFaas pods.</p>\n</li>\n<li>\n<p><strong>Annotations</strong>\nAdd or remove SlimFaas <strong>annotations</strong> on your pods/Deployments to control scaling, concurrency, visibility, and timeouts.</p>\n</li>\n<li>\n<p><strong>Public vs. Private</strong>\nRestricts who can access a function/job (any external caller vs. same-namespace or trusted pods).</p>\n</li>\n</ol>\n<hr>\n<h2>2. Request Flow</h2>\n<h3>Synchronous HTTP Calls</h3>\n<ol>\n<li><strong>Client → SlimFaas</strong>\n<code>GET /function/&lt;functionName&gt;/...</code></li>\n<li><strong>SlimFaas</strong> ensures the target function is scaled up and ready.</li>\n<li><strong>SlimFaas → Function</strong>\nWait for the function’s response.</li>\n<li><strong>SlimFaas</strong> returns the function’s response to the client.</li>\n</ol>\n<p><img src=\"https://github.com/AxaFrance/SlimFaas/blob/main/documentation/sync_http_call.PNG?raw=true\" alt=\"sync_http_call.PNG\"></p>\n<h3>Asynchronous HTTP Calls</h3>\n<ol>\n<li><strong>Client → SlimFaas</strong>\n<code>GET /async-function/&lt;functionName&gt;/...</code> (returns immediately with <code>202 Accepted</code>).</li>\n<li><strong>SlimFaas</strong> enqueues the request in SlimData.</li>\n<li><strong>SlimWorker</strong> processes requests in the background, respecting concurrency limits.</li>\n<li><strong>Function</strong> handles each request. SlimFaas logs outcomes in SlimData.</li>\n</ol>\n<p><img src=\"https://github.com/AxaFrance/SlimFaas/blob/main/documentation/async_http_call.PNG?raw=true\" alt=\"async_http_call.PNG\"></p>\n<h3>Publish/Subscribe (Events)</h3>\n<ol>\n<li><strong>Client → SlimFaas</strong>\n<code>POST /publish-event/&lt;eventName&gt;</code> with JSON payload.</li>\n<li>SlimFaas synchronously broadcasts the payload to each subscribed function’s replicas.</li>\n<li>Each replica processes the event and responds individually to SlimFaas.</li>\n</ol>\n<p><img src=\"https://github.com/AxaFrance/SlimFaas/blob/main/documentation/publish_sync_call.png?raw=true\" alt=\"publish_sync_call.png\"></p>\n<hr>\n<h2>3. Scaling Logic</h2>\n<ul>\n<li><strong>Scale to 0</strong> after a defined inactivity (<code>SlimFaas/TimeoutSecondBeforeSetReplicasMin</code>).</li>\n<li><strong>Scale from 0 to 1+</strong> when a new request arrives or <code>wake-function</code> is called.</li>\n<li><strong>Optional</strong>: Use standard K8s Horizontal Pod Autoscalers or KEDA if you need more advanced scaling triggers.</li>\n</ul>\n<hr>\n<h2>4. CPU-Aware Rate Limiting</h2>\n<p>SlimFaas includes built-in <strong>load shedding</strong> to protect your cluster during traffic spikes by automatically rejecting requests when CPU usage exceeds configurable thresholds.</p>\n<h3>Key Features</h3>\n<ul>\n<li><strong>Hysteresis support</strong>: Prevents rapid toggling between limited and normal states with separate high/low thresholds.</li>\n<li><strong>Port-specific</strong>: Applies to all SlimFaas ports <strong>except</strong> the SlimData internal port (used for cluster coordination).</li>\n<li><strong>Path exclusions</strong>: Configurable list of paths to exclude (e.g., health checks, metrics endpoints).</li>\n<li><strong>Native AOT compatible</strong>: Minimal performance overhead.</li>\n</ul>\n<h3>How It Works</h3>\n<ol>\n<li><strong>Monitoring</strong>: A background service continuously samples CPU usage at a configurable interval.</li>\n<li><strong>Activation</strong>: When CPU exceeds the <code>CpuHighThreshold</code>, the middleware starts rejecting requests with <code>429 Too Many Requests</code>.</li>\n<li><strong>Deactivation</strong>: When CPU drops below the <code>CpuLowThreshold</code>, normal processing resumes.</li>\n<li><strong>Exemptions</strong>: The SlimData port (used for internal cluster communication) is always exempt from rate limiting.</li>\n</ol>\n<h3>Configuration</h3>\n<p>Add the following to your <code>appsettings.json</code>:</p>\n<pre><code class=\"language-json hljs\"><span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">\"SlimFaas\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">{</span>\n    <span class=\"hljs-attr\">\"RateLimiting\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">{</span>\n      <span class=\"hljs-attr\">\"Enabled\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">\"CpuHighThreshold\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">80.0</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">\"CpuLowThreshold\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">60.0</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">\"SampleIntervalMs\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1000</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">\"RetryAfterSeconds\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">30</span><span class=\"hljs-punctuation\">,</span>\n      <span class=\"hljs-attr\">\"ExcludedPaths\"</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span>\n        <span class=\"hljs-string\">\"/health\"</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">\"/ready\"</span><span class=\"hljs-punctuation\">,</span>\n        <span class=\"hljs-string\">\"/metrics\"</span>\n      <span class=\"hljs-punctuation\">]</span>\n    <span class=\"hljs-punctuation\">}</span>\n  <span class=\"hljs-punctuation\">}</span>\n<span class=\"hljs-punctuation\">}</span>\n</code></pre>\n<p><strong>Parameters:</strong></p>\n<ul>\n<li><code>Enabled</code> (bool): Enable or disable CPU rate limiting.</li>\n<li><code>CpuHighThreshold</code> (double, 0-100): CPU percentage that triggers rate limiting.</li>\n<li><code>CpuLowThreshold</code> (double, 0-100): CPU percentage that stops rate limiting (must be &lt; CpuHighThreshold).</li>\n<li><code>SampleIntervalMs</code> (int, ≥100): How often to sample CPU usage (milliseconds).</li>\n<li><code>RetryAfterSeconds</code> (int?, optional): Value for the <code>Retry-After</code> header in 429 responses.</li>\n<li><code>ExcludedPaths</code> (string[]): List of paths that bypass rate limiting (e.g., health checks).</li>\n</ul>\n<p><strong>Validation:</strong></p>\n<ul>\n<li><code>CpuLowThreshold &lt; CpuHighThreshold</code></li>\n<li>Both thresholds must be between 0 and 100</li>\n<li><code>SampleIntervalMs</code> must be ≥ 100</li>\n</ul>\n<h3>Port Exemption</h3>\n<p>The CPU rate limiting middleware automatically exempts the <strong>SlimData port</strong> (configured via <code>publicEndPoint</code> in your SlimData configuration). This ensures that:</p>\n<ul>\n<li>Internal cluster coordination is never throttled</li>\n<li>Raft consensus and state synchronization continue uninterrupted</li>\n<li>Only external/public traffic on other ports is subject to rate limiting</li>\n</ul>\n<p>This design keeps your control plane healthy even under extreme load.</p>\n<hr>\n<h2>5. Build &amp; Technology Stack</h2>\n<p>SlimFaas is developed in <strong>.NET</strong>, chosen for its:</p>\n<ul>\n<li>High performance in web APIs. SlimFaas is compile in Ahead Of Time (AOT) mode which produce a <strong>native</strong> application.</li>\n<li>Excellent concurrency model.</li>\n<li>Constant improvements in speed and memory usage.</li>\n<li>Compact container images.</li>\n</ul>\n<hr>\n<p>That’s the architecture in a nutshell! SlimFaas ensures your functions and jobs scale efficiently while\nremaining lightweight and easy to set up.</p>\n</body></html>","metadata":{}},"__N_SSG":true}